---
import { feedURLs } from '../data/feeds.js';
import '../styles/rss-joy.css';

import { XMLParser } from 'fast-xml-parser';
const parser = new XMLParser();

async function rss2data(url: RequestInfo | URL, max = 5) {
	const rssResponse = await fetch(url);
	const rssText = await rssResponse.text();
	const feed = parser.parse(rssText);
	const title = feed.rss ? feed.rss.channel.title : feed.feed.title;
	const link = feed.rss ? feed.rss.channel.link : feed.feed.id;
	const posts = feed.rss ? feed.rss.channel.item : feed.feed.entry;
	let entries = [];
	for (let entry = 0; entry < max; entry++) {
		entries.push({
			"title": posts[entry].title,
			"link": posts[entry].id ?? posts[entry].guid,
		});
	}
	return {
		"title": title,
		"link": link,
		"entries": entries,
	}
}

let rssCards = [];
for (const feedURL of feedURLs) {
	rssCards.push(await rss2data(feedURL));
}

---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒˆ</text></svg>" />
		<title>RSS JOY</title>
	</head>
	<body>
		<header>
			<h1>RS.S JOY.lol</h1>
			<p>An RSS-some starting page.</p>
		</header>
		<main>
			{rssCards.map((rssCard) => (
				<article style=`--hue: ${Math.round(Math.random() * 360)}`>
					<h2><a href={rssCard.link}>{rssCard.title}</a></h2>
					<ul>
					{rssCard.entries.map((entry: { link: string | URL; title: string; }) => (
						<li><a href={entry.link}>{entry.title}</a></li>
					))}
					</ul>
				</article>
			))}
		</main>
		<footer>
			<p>2024 <a href="https://sarajoy.dev">Sara Joy</a></p>
		</footer>
	</body>
</html>